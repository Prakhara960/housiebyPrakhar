<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tambola Elite - Advanced Sync V7</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800;900&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #FF3D00; --gold: #FFD700; --bg: #0b0b14; --card: #ffffff; --green: #00C853; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Outfit', sans-serif; background: var(--bg); color: #fff; margin: 0; padding: env(safe-area-inset-top) 10px 20px; display: flex; justify-content: center; }
        .app { width: 100%; max-width: 450px; }
        
        .glass-card { background: var(--card); border-radius: 28px; padding: 20px; color: #1a1a1a; margin-bottom: 15px; box-shadow: 0 15px 35px rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); }
        
        /* Advanced Grid */
        .grid { display: grid; grid-template-columns: repeat(9, 1fr); gap: 2px; background: #e0e0e0; border: 2px solid #333; border-radius: 12px; overflow: hidden; padding: 2px; }
        .cell { background: #fff; height: 50px; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: 800; cursor: pointer; position: relative; transition: 0.2s; }
        .cell.marked { color: white; background: var(--primary) !important; box-shadow: inset 0 0 10px rgba(0,0,0,0.2); }
        .cell.empty { background: #f5f5f7; }
        .cell.last-called { animation: pulse-border 1.5s infinite; background: #fffde7; }
        @keyframes pulse-border { 0% { box-shadow: inset 0 0 0px var(--primary); } 50% { box-shadow: inset 0 0 15px var(--primary); } 100% { box-shadow: inset 0 0 0px var(--primary); } }

        /* Real-time Call View */
        .call-container { text-align: center; padding: 10px; position: relative; }
        .big-call { font-size: 100px; font-weight: 900; color: var(--primary); line-height: 1; letter-spacing: -4px; margin: 10px 0; transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .big-call.new { transform: scale(1.2); }
        
        /* Buttons */
        .btn { border: none; border-radius: 18px; padding: 18px; font-weight: 800; cursor: pointer; width: 100%; transition: 0.3s active; font-size: 14px; text-transform: uppercase; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-p { background: linear-gradient(135deg, #FF3D00, #FF6E40); color: white; box-shadow: 0 8px 20px rgba(255,61,0,0.3); }
        .btn:active { transform: scale(0.96); opacity: 0.9; }
        
        /* Prize Rows */
        .prize-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f0f0f0; }
        .prize-row:last-child { border: none; }
        .prize-info b { font-size: 14px; color: #333; }
        .prize-amt { font-size: 12px; color: var(--primary); font-weight: 900; background: rgba(255,61,0,0.1); padding: 2px 8px; border-radius: 6px; }
        .fh-special { background: linear-gradient(to right, #fff9e6, #fff); border-left: 5px solid var(--gold); padding: 12px; border-radius: 12px; margin-top: 8px; }
        
        .status-tag { font-size: 10px; padding: 4px 10px; border-radius: 20px; font-weight: 900; text-transform: uppercase; }
        .status-online { background: #e8f5e9; color: #2e7d32; }
        
        .hidden { display: none !important; }
        .history-dots { display: flex; justify-content: center; gap: 8px; margin-top: 10px; }
        .dot { width: 38px; height: 38px; border-radius: 50%; background: #eee; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 800; color: #666; transition: 0.5s; }
        .dot.active { background: #1a1a1a; color: #fff; transform: scale(1.1); border: 2px solid var(--primary); }
    </style>
</head>
<body>

<div class="app">
    <div id="lobby" class="glass-card" style="text-align: center;">
        <h1 style="font-size: 32px; font-weight: 900; margin: 0; letter-spacing: -1.5px;">TAMBOLA<span style="color:var(--primary)">ELITE</span></h1>
        <p style="color:#888; font-size: 13px; margin-bottom: 30px;">‚Çπ300 Pool ‚Ä¢ Advanced Real-time Engine</p>
        <input type="text" id="nick" placeholder="Enter Your Nickname">
        <button class="btn btn-p" onclick="start(true)">üöÄ Host Grand Game</button>
        <div style="margin: 15px; font-weight: 900; color: #ddd; font-size: 12px;">OR JOIN ROOM</div>
        <input type="text" id="joinCode" placeholder="Paste 8-Digit Room Code">
        <button class="btn" style="background:#1a1a1a; color:white;" onclick="start(false)">üéÆ Join Now</button>
    </div>

    <div id="game-board" class="hidden">
        <div id="host-controls" class="glass-card hidden" style="text-align: center;">
            <div id="player-count" style="margin-bottom: 10px;"></div>
            <div class="call-container">
                <div class="big-call" id="mainNum">--</div>
            </div>
            <button class="btn btn-p" onclick="drawNext()">NEXT NUMBER</button>
            <button class="btn" style="background:#25D366; color:white; font-size:12px;" onclick="copyInvite()">üì§ COPY WHATSAPP INVITE</button>
        </div>

        <div class="glass-card" style="padding: 15px;">
            <div class="history-dots" id="recentHistory">
                <div class="dot">--</div><div class="dot">--</div><div class="dot">--</div><div class="dot">--</div><div class="dot">--</div>
            </div>
        </div>

        <div class="glass-card">
            <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <span style="font-size:11px; font-weight:900; color:#aaa; text-transform:uppercase;">Live Dividends</span>
                <span id="sync-status" class="status-tag status-online">Syncing...</span>
            </div>
            <div id="prizeList"></div>
        </div>

        <div class="glass-card" style="padding: 10px;">
            <div style="display:flex; justify-content: space-between; font-size: 13px; font-weight: 900; margin-bottom: 12px; padding: 0 5px;">
                <span id="display-name">PLAYER</span>
                <span style="color:var(--primary)">#TICKET-ELITE</span>
            </div>
            <div class="grid" id="ticketGrid"></div>
        </div>
    </div>
</div>

<script>
    let peer, conn, isHost, myTicket = [], players = [], connections = [];
    let called = [], dividends = [
        {name: "Early 5", amt: 20, winner: null},
        {name: "Top Line", amt: 15, winner: null},
        {name: "Middle Line", amt: 15, winner: null},
        {name: "Bottom Line", amt: 15, winner: null},
        {name: "Corners", amt: 15, winner: null},
        {name: "Middle Number", amt: 10, winner: null},
        {name: "Breakfast (Col 1-3)", amt: 20, winner: null},
        {name: "Lunch (Col 4-6)", amt: 20, winner: null},
        {name: "Dinner (Col 7-9)", amt: 20, winner: null},
        {name: "Full House 1", amt: 70, winner: null, isFH: true},
        {name: "Full House 2", amt: 50, winner: null, isFH: true},
        {name: "Full House 3", amt: 30, winner: null, isFH: true}
    ];

    function start(hostMode) {
        const name = document.getElementById('nick').value;
        if(!name) return alert("Please enter your name!");
        isHost = hostMode;
        
        peer = new Peer();

        peer.on('open', id => {
            document.getElementById('lobby').classList.add('hidden');
            document.getElementById('game-board').classList.remove('hidden');
            document.getElementById('display-name').innerText = name.toUpperCase();
            
            if(isHost) {
                players = [name];
                document.getElementById('host-controls').classList.remove('hidden');
                peer.on('connection', c => {
                    connections.push(c);
                    c.on('data', data => handleSignals(data, c));
                });
                updateView();
            } else {
                const code = document.getElementById('joinCode').value.trim();
                connectToHost(code, name);
            }
            createTicket();
        });
    }

    function connectToHost(code, name) {
        conn = peer.connect(code, {reliable: true});
        conn.on('open', () => {
            conn.send({type: 'JOIN_REQ', name: name});
            document.getElementById('sync-status').innerText = "Connected";
        });
        conn.on('data', data => handleSignals(data));
        conn.on('close', () => {
            document.getElementById('sync-status').innerText = "Disconnected! Reconnecting...";
            setTimeout(() => connectToHost(code, name), 2000);
        });
    }

    function handleSignals(d, c) {
        if(d.type === 'FULL_SYNC') {
            called = d.called;
            dividends = d.dividends;
            players = d.players;
            updateView();
        }
        if(d.type === 'JOIN_REQ' && isHost) {
            if(!players.includes(d.name)) players.push(d.name);
            broadcast();
        }
        if(d.type === 'CLAIM_REQ' && isHost) {
            if(!dividends[d.idx].winner) {
                dividends[d.idx].winner = d.name;
                broadcast();
                if(dividends[d.idx].isFH) startCelebration();
            }
        }
    }

    function broadcast() {
        if(!isHost) return;
        const msg = { type: 'FULL_SYNC', called, dividends, players };
        connections.forEach(c => { if(c.open) c.send(msg); });
        updateView();
    }

    function drawNext() {
        if(!isHost || called.length >= 90) return;
        let n; do { n = Math.floor(Math.random()*90)+1; } while(called.includes(n));
        called.push(n);
        broadcast();
        speakNumber(n);
    }

    function createTicket() {
        const grid = Array.from({length: 3}, () => Array(9).fill(0));
        const pools = Array.from({length: 9}, (_, i) => {
            let s = i === 0 ? 1 : i * 10, e = i === 8 ? 90 : i * 10 + 9;
            return Array.from({length: e-s+1}, (_, j) => s+j).sort(() => Math.random() - 0.5);
        });
        for(let r=0; r<3; r++) {
            let cols = [0,1,2,3,4,5,6,7,8].sort(() => Math.random() - 0.5).slice(0, 5);
            cols.forEach(c => grid[r][c] = pools[c].pop());
        }
        for(let c=0; c<9; c++) {
            let temp = []; for(let r=0; r<3; r++) if(grid[r][c]) temp.push(grid[r][c]);
            temp.sort((a,b) => a-b); let idx = 0;
            for(let r=0; r<3; r++) if(grid[r][c]) grid[r][c] = temp[idx++];
        }
        myTicket = grid;
        const container = document.getElementById('ticketGrid');
        container.innerHTML = '';
        grid.flat().forEach(n => {
            const el = document.createElement('div');
            el.className = n ? 'cell' : 'cell empty';
            el.innerText = n || '';
            if(n) el.onclick = () => { if(called.includes(n)) el.classList.toggle('marked'); };
            container.appendChild(el);
        });
    }

    function updateView() {
        const lastFive = [...called].reverse().slice(0, 5);
        document.querySelectorAll('.dot').forEach((d, i) => {
            d.innerText = lastFive[i] || '--';
            d.className = i === 0 && lastFive[i] ? 'dot active' : 'dot';
        });

        if(isHost) {
            document.getElementById('mainNum').innerText = called[called.length-1] || '--';
            document.getElementById('player-count').innerHTML = players.map(p => `<span class="player-chip">${p}</span>`).join('');
            document.getElementById('mainNum').classList.add('new');
            setTimeout(() => document.getElementById('mainNum').classList.remove('new'), 300);
        }

        document.getElementById('prizeList').innerHTML = dividends.map((d, i) => `
            <div class="prize-row ${d.isFH ? 'fh-special' : ''}">
                <div class="prize-info">
                    <b>${d.name}</b> <span class="prize-amt">‚Çπ${d.amt}</span>
                </div>
                ${d.winner ? `<b style="color:var(--green); font-size:12px;">üèÜ ${d.winner}</b>` : `<button onclick="submitClaim(${i})" style="background:#000; color:#fff; border:none; padding:6px 15px; border-radius:10px; font-size:11px; font-weight:800;">CLAIM</button>`}
            </div>`).join('');
            
        // Highlight last called on ticket
        const lastNum = called[called.length-1];
        document.querySelectorAll('.cell').forEach(c => {
            c.classList.remove('last-called');
            if(parseInt(c.innerText) === lastNum) c.classList.add('last-called');
        });
    }

    function submitClaim(idx) {
        const marked = Array.from(document.querySelectorAll('.cell.marked')).map(el => parseInt(el.innerText));
        const rowNums = myTicket.map(row => row.filter(n => n > 0));
        let type = dividends[idx].name;
        let valid = false;

        if(!marked.every(n => called.includes(n))) return alert("Busted! Some marked numbers not called.");

        if(type === "Early 5") valid = marked.length >= 5;
        else if(type.includes("Line")) {
            let rIdx = type.includes("Top") ? 0 : type.includes("Middle") ? 1 : 2;
            valid = rowNums[rIdx].every(n => marked.includes(n));
        }
        else if(type.includes("Full House")) valid = marked.length === 15;
        else if(type === "Corners") {
            let c = [rowNums[0][0], rowNums[0][rowNums[0].length-1], rowNums[2][0], rowNums[2][rowNums[2].length-1]];
            valid = c.every(n => marked.includes(n));
        }
        else if(type === "Middle Number") valid = marked.includes(rowNums[1][2]);
        else if(type.includes("Col")) {
            let start = type.includes("1-3") ? 0 : type.includes("4-6") ? 3 : 6;
            valid = [0,1,2].every(i => {
                let col = start + i;
                return myTicket.every(r => r[col] === 0 || marked.includes(r[col]));
            });
        }

        if(valid) {
            const msg = {type: 'CLAIM_REQ', idx, name: document.getElementById('nick').value};
            if(isHost) handleSignals(msg); else conn.send(msg);
            alert("Verification sent to host!");
        } else alert("Pattern incomplete!");
    }

    function speakNumber(n) {
        try {
            window.speechSynthesis.cancel();
            let msg = new SpeechSynthesisUtterance(n.toString());
            msg.rate = 0.9;
            window.speechSynthesis.speak(msg);
        } catch(e) {}
    }

    function startCelebration() {
        var end = Date.now() + (4 * 1000);
        (function frame() {
            confetti({ particleCount: 7, angle: 60, spread: 55, origin: { x: 0 } });
            confetti({ particleCount: 7, angle: 120, spread: 55, origin: { x: 1 } });
            if (Date.now() < end) requestAnimationFrame(frame);
        }());
    }

    function copyInvite() {
        const url = window.location.origin + window.location.pathname + "?game=" + peer.id;
        navigator.clipboard.writeText(`Join my Tambola Room! üéüÔ∏è\nCode: ${peer.id}\nLink: ${url}`);
        alert("Invite Copied! Send to WhatsApp.");
    }

    window.onload = () => {
        const p = new URLSearchParams(window.location.search);
        if(p.has('game')) document.getElementById('joinCode').value = p.get('game');
    };
</script>
</body>
</html>
