<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tambola Live - Instant Sync</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #FF3D00; --gold: #FFD700; --bg: #0b0b14; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { font-family: 'Outfit', sans-serif; background: var(--bg); color: #fff; margin: 0; padding: 10px; }
        .app { width: 100%; max-width: 450px; margin: auto; }
        .card { background: #fff; border-radius: 20px; padding: 15px; color: #1a1a1a; margin-bottom: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid rgba(0,0,0,0.05); }
        
        /* Host Real-time Player List */
        .host-dashboard { background: #f0f7ff; border: 2px solid #007bff; border-radius: 15px; padding: 12px; margin-bottom: 15px; }
        .live-indicator { height: 10px; width: 10px; background: #ff0000; border-radius: 50%; display: inline-block; animation: blink 1s infinite; margin-right: 5px; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
        .player-chips { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .p-chip { background: #1a1a1a; color: #fff; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 700; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

        /* Calling Area */
        .call-box { text-align: center; padding: 10px 0; }
        .num-main { font-size: 100px; font-weight: 900; color: var(--primary); line-height: 1; }
        
        /* Ticket Grid */
        .grid { display: grid; grid-template-columns: repeat(9, 1fr); gap: 2px; background: #333; border: 2px solid #000; border-radius: 10px; overflow: hidden; }
        .cell { background: #fff; height: 50px; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: 800; }
        .cell.marked { background: var(--primary) !important; color: #fff; box-shadow: inset 0 0 10px rgba(0,0,0,0.3); }
        .cell.empty { background: #f1f3f5; }

        .btn { border: none; border-radius: 15px; padding: 18px; font-weight: 800; width: 100%; cursor: pointer; text-transform: uppercase; font-size: 15px; transition: 0.2s; }
        .btn-p { background: linear-gradient(135deg, var(--primary), #ff7043); color: white; }
        .btn:active { transform: scale(0.97); }
        input { width: 100%; padding: 15px; border-radius: 12px; border: 2px solid #eee; margin-bottom: 10px; text-align: center; font-weight: 700; font-size: 16px; background: #fafafa; }
        
        .prize-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f0f0f0; }
        .prize-item:last-child { border: none; }
        .fh-card { background: #fff9e6; border: 1.5px solid var(--gold); border-radius: 12px; padding: 12px; margin-top: 8px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="app">
    <div id="view-setup" class="card" style="text-align: center;">
        <h1 style="margin:0; font-weight:900; color:var(--primary); letter-spacing:-1px;">TAMBOLA LIVE</h1>
        <p style="font-size:12px; color:#888; margin-bottom:20px;">‚Çπ300 PRIZE POOL ‚Ä¢ INSTANT SYNC</p>
        <input type="text" id="inp-name" placeholder="YOUR NAME">
        <button class="btn btn-p" onclick="connect(true)">HOST GAME</button>
        <div style="margin:12px; font-weight:900; color:#ddd;">OR</div>
        <input type="text" id="inp-id" placeholder="ROOM CODE">
        <button class="btn" style="background:#1a1a1a; color:white;" onclick="connect(false)">JOIN ROOM</button>
    </div>

    <div id="view-game" class="hidden">
        <div id="host-panel" class="card host-dashboard hidden">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span style="font-size:13px; font-weight:900; color:#007bff;"><span class="live-indicator"></span>LIVE PLAYERS</span>
                <button onclick="copyCode()" style="background:#007bff; color:white; border:none; padding:4px 10px; border-radius:8px; font-size:10px; font-weight:800;">COPY ID</button>
            </div>
            <div id="live-players" class="player-chips"></div>
            <div class="call-box">
                <div class="num-main" id="call-num">--</div>
            </div>
            <button class="btn btn-p" onclick="draw()">CALL NEXT</button>
        </div>

        <div id="player-status" class="card" style="padding:10px; text-align:center; font-size:12px; font-weight:800; color:#4CAF50;">
            ‚úì INSTANT SYNC ACTIVE
        </div>

        <div class="card">
            <span style="font-size:11px; font-weight:900; color:#aaa; text-transform:uppercase;">Dividends</span>
            <div id="prize-list"></div>
        </div>

        <div class="card" style="padding:10px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <b id="tag-name" style="font-size:13px; color:#333;">PLAYER</b>
                <b style="color:var(--primary); font-size:13px;">TICKET #101</b>
            </div>
            <div class="grid" id="ticket-grid"></div>
        </div>
    </div>
</div>

<script>
    let peer, conn, isHost, myTicket = [], players = [], allConns = [];
    let called = [], dividends = [
        {name: "Early 5", amt: 20, win: null},
        {name: "Top Line", amt: 15, win: null},
        {name: "Middle Line", amt: 15, win: null},
        {name: "Bottom Line", amt: 15, win: null},
        {name: "Corners", amt: 15, win: null},
        {name: "Middle Number", amt: 10, win: null},
        {name: "Col 1-3", amt: 20, win: null},
        {name: "Col 4-6", amt: 20, win: null},
        {name: "Col 7-9", amt: 20, win: null},
        {name: "Full House 1", amt: 70, win: null, isFH: true},
        {name: "Full House 2", amt: 50, win: null, isFH: true},
        {name: "Full House 3", amt: 30, win: null, isFH: true}
    ];

    function connect(hostMode) {
        const name = document.getElementById('inp-name').value.trim();
        if(!name) return alert("Enter Name");
        isHost = hostMode;
        peer = new Peer();

        peer.on('open', id => {
            document.getElementById('view-setup').classList.add('hidden');
            document.getElementById('view-game').classList.remove('hidden');
            document.getElementById('tag-name').innerText = name.toUpperCase();
            
            // Build UI immediately so player sees everything instantly
            buildTicket();
            renderPrizes();

            if(isHost) {
                players = [name];
                document.getElementById('host-panel').classList.remove('hidden');
                document.getElementById('player-status').classList.add('hidden');
                peer.on('connection', c => {
                    allConns.push(c);
                    c.on('data', d => {
                        if(d.type === 'JOIN') {
                            if(!players.includes(d.name)) players.push(d.name);
                            syncAll();
                        }
                        if(d.type === 'CLAIM') handleClaim(d);
                    });
                    c.on('open', () => syncAll());
                });
                updateLivePlayers();
            } else {
                const room = document.getElementById('inp-id').value.trim();
                conn = peer.connect(room, {reliable: true});
                conn.on('open', () => conn.send({type: 'JOIN', name: name}));
                conn.on('data', d => {
                    if(d.type === 'SYNC') {
                        called = d.called; dividends = d.dividends; players = d.players;
                        renderPrizes();
                        // Audio for player
                        if(d.last) speak(d.last);
                    }
                });
            }
        });
    }

    function buildTicket() {
        const grid = Array.from({length: 3}, () => Array(9).fill(0));
        const pools = Array.from({length: 9}, (_, i) => {
            let s = i === 0 ? 1 : i * 10, e = i === 8 ? 90 : i * 10 + 9;
            return Array.from({length: e-s+1}, (_, j) => s+j).sort(() => Math.random() - 0.5);
        });
        for(let r=0; r<3; r++) {
            let cols = [0,1,2,3,4,5,6,7,8].sort(() => Math.random() - 0.5).slice(0, 5);
            cols.forEach(c => grid[r][c] = pools[c].pop());
        }
        for(let c=0; c<9; c++) {
            let t = []; for(let r=0; r<3; r++) if(grid[r][c]) t.push(grid[r][c]);
            t.sort((a,b)=>a-b); let idx=0;
            for(let r=0; r<3; r++) if(grid[r][c]) grid[r][c] = t[idx++];
        }
        myTicket = grid;
        const container = document.getElementById('ticket-grid');
        container.innerHTML = '';
        grid.flat().forEach(n => {
            const el = document.createElement('div');
            el.className = n ? 'cell' : 'cell empty';
            el.innerText = n || '';
            if(n) el.onclick = () => { if(called.includes(n)) el.classList.toggle('marked'); };
            container.appendChild(el);
        });
    }

    function syncAll() {
        if(!isHost) return;
        const lastNum = called[called.length-1];
        const data = {type: 'SYNC', called, dividends, players, last: lastNum};
        allConns.forEach(c => { if(c.open) c.send(data); });
        updateLivePlayers();
        renderPrizes();
        document.getElementById('call-num').innerText = lastNum || '--';
    }

    function draw() {
        if(!isHost || called.length >= 90) return;
        let n; do { n = Math.floor(Math.random()*90)+1; } while(called.includes(n));
        called.push(n);
        syncAll();
        speak(n);
    }

    function handleClaim(d) {
        if(!dividends[d.idx].win) {
            dividends[d.idx].win = d.name;
            syncAll();
            if(dividends[d.idx].isFH) confetti({particleCount: 150, spread: 70, origin: { y: 0.6 }});
        }
    }

    function renderPrizes() {
        document.getElementById('prize-list').innerHTML = dividends.map((d, i) => `
            <div class="prize-item ${d.isFH ? 'fh-card' : ''}">
                <div><b style="font-size:13px">${d.name}</b><br><small style="color:var(--primary); font-weight:900;">‚Çπ${d.amt}</small></div>
                ${d.win ? `<b style="color:#2ecc71; font-size:12px;">üèÜ ${d.win}</b>` : `<button onclick="sendClaim(${i})" style="background:#000; color:#fff; border:none; padding:7px 16px; border-radius:10px; font-size:11px; font-weight:800; cursor:pointer;">CLAIM</button>`}
            </div>`).join('');
    }

    function updateLivePlayers() {
        document.getElementById('live-players').innerHTML = players.map(p => `<span class="p-chip">${p}</span>`).join('');
    }

    function sendClaim(idx) {
        const marked = Array.from(document.querySelectorAll('.cell.marked')).map(el => parseInt(el.innerText));
        if(marked.length === 0) return alert("Mark ticket!");
        const data = {type: 'CLAIM', idx, name: document.getElementById('inp-name').value};
        if(isHost) handleClaim(data); else conn.send(data);
        alert("Claimed! Check host screen.");
    }

    function speak(n) {
        try { window.speechSynthesis.cancel(); window.speechSynthesis.speak(new SpeechSynthesisUtterance(n.toString())); } catch(e){}
    }

    function copyCode() {
        navigator.clipboard.writeText(peer.id);
        alert("Copied: " + peer.id);
    }
</script>
</body>
</html>
